<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Creatures</title>
    <link rel="icon" href="../img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="../css/partida.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <div class="fondo">

        <div class="juego-container">

            <h2 class="txt-ronda" id="txt-ronda">Ronda 1</h2>

            <div class="jugadores" id="jugadores-container">
                <!-- Jugadores se cargarán dinámicamente -->
            </div>

            <div class="seleccion-container">
                <h3>Selecciona un poder</h3>
                
                <div class="poderes">
                    <div class="poder">
                        <p>Fuerza</p>
                        <img src="../img/fuerza.png" alt="Fuerza">
                    </div>
                    <div class="poder">
                        <p>Velocidad</p>
                        <img src="../img/velocidad.png" alt="Velocidad">
                    </div>
                    <div class="poder">
                        <p>Resistencia</p>
                        <img src="../img/resistencia.png" alt="Resistencia">
                    </div>
                    <div class="poder">
                        <p>Sigilo</p>
                        <img src="../img/sigilo.png" alt="Sigilo">
                    </div>
                    <div class="poder">
                        <p>Sabiduría</p>
                        <img src="../img/sabiduria.png" alt="Sabiduría">
                    </div>
                    <div class="poder">
                        <p>Curación</p>
                        <img src="../img/curacion.png" alt="Curación">
                    </div>
                </div>
            </div>
        </div>

    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const jugadoresSection = document.getElementById("jugadores-container");
    const txtRonda = document.getElementById("txt-ronda");
    const poderes = document.querySelectorAll(".poder");
    
    // Obtener jugadores de sessionStorage
    const jugadores = JSON.parse(sessionStorage.getItem("jugadores")) || [];
    const idSala = sessionStorage.getItem("idSala");
    
    if (!jugadores.length || !idSala) {
        alert("Error: No se encontraron datos de la partida");
        window.location.href = "sala.html";
        return;
    }
    
    // Estado del juego
    let rondaActual = 1;
    let jugadorActual = 0;
    let cartasJugadores = {};
    let puntosJugadores = {};
    
    // Inicializar juego
    function inicializarJuego() {
        jugadoresSection.innerHTML = "";
        
        // Inicializar cartas y puntos
        jugadores.forEach((nombre, index) => {
            cartasJugadores[index] = 8;
            puntosJugadores[index] = 0;
            
            // Crear elemento de jugador
            const jugadorDiv = document.createElement("div");
            jugadorDiv.className = "jugador";
            const avatarNum = (index % 6) + 1;
            
            jugadorDiv.innerHTML = `
                <img src="../img/avatar${avatarNum}.png" alt="${nombre}">
                <p>${nombre}</p>
                <div>
                    <div class="cartas"></div>
                    <p class="num-cartas">${cartasJugadores[index]} Cartas</p>
                </div>
            `;
            
            jugadoresSection.appendChild(jugadorDiv);
        });
        
        // Actualizar ronda
        txtRonda.textContent = `Ronda ${rondaActual}`;
    }
    
    // Manejar selección de poder
    poderes.forEach(poder => {
        poder.addEventListener("click", function() {
            const atributo = this.querySelector("p").textContent.toLowerCase();
            
            try {
                // Simular lógica del juego
                const ganador = Math.floor(Math.random() * jugadores.length);
                
                // Actualizar cartas
                cartasJugadores[ganador] += 1;
                puntosJugadores[ganador] += 1;
                cartasJugadores[jugadorActual] -= 1;
                
                // Actualizar vista
                document.querySelectorAll(".num-cartas")[jugadorActual].textContent = 
                    `${cartasJugadores[jugadorActual]} Cartas`;
                document.querySelectorAll(".num-cartas")[ganador].textContent = 
                    `${cartasJugadores[ganador]} Cartas`;
                
                // Pasar al siguiente jugador
                jugadorActual = (jugadorActual + 1) % jugadores.length;
                
                // Si todos han jugado, siguiente ronda
                if (jugadorActual === 0) {
                    rondaActual++;
                    txtRonda.textContent = `Ronda ${rondaActual}`;
                }
                
                // Verificar fin del juego
                const jugadoresConCartas = Object.values(cartasJugadores).filter(c => c > 0).length;
                if (jugadoresConCartas <= 1) {
                    finalizarJuego();
                }
            } catch (error) {
                console.error("Error en la partida:", error);
                alert("Ocurrió un error durante la partida");
            }
        });
    });
    
    // Finalizar juego
    async function finalizarJuego() {
        let ganador = 0;
        let maxPuntos = 0;
        
        for (let i = 0; i < jugadores.length; i++) {
            if (puntosJugadores[i] > maxPuntos) {
                maxPuntos = puntosJugadores[i];
                ganador = i;
            }
        }
        
        alert(`¡El juego ha terminado! Ganador: ${jugadores[ganador]} con ${maxPuntos} puntos`);
        
        // Redirigir después de 3 segundos
        setTimeout(() => {
            window.location.href = "../index.html";
        }, 3000);
    }
    
    // Inicializar el juego
    inicializarJuego();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>